var BillController=function(){function e(){$("#txtFromDate, #txtToDate").datepicker({autoclose:!0,format:"dd/mm/yyyy"});$("#frmMaintainance").validate({errorClass:"red",ignore:[],lang:"vi",rules:{txtCustomerName:{required:!0},txtCustomerAddress:{required:!0},txtCustomerMobile:{required:!0},txtCustomerMessage:{required:!0},ddlBillStatus:{required:!0}}});$("#txt-search-keyword").keypress(function(n){n.which===13&&(n.preventDefault(),t())});$("#btn-search").on("click",function(){t()});$("#btn-create").on("click",function(){f();$("#modal-detail").modal("show")});$("#ddl-show-page").on("change",function(){tedu.configs.pageSize=$(this).val();tedu.configs.pageIndex=1;t(!0)});$("body").on("click",".btn-view",function(n){n.preventDefault();var t=$(this).data("id");$.ajax({type:"GET",url:"/Admin/Bill/GetById",data:{id:t},beforeSend:function(){tedu.startLoading()},success:function(n){var t=n,e,f,o;$("#hidId").val(t.Id);$("#txtCustomerName").val(t.CustomerName);$("#txtCustomerAddress").val(t.CustomerAddress);$("#txtCustomerMobile").val(t.CustomerMobile);$("#txtCustomerMessage").val(t.CustomerMessage);$("#ddlPaymentMethod").val(t.PaymentMethod);$("#ddlCustomerId").val(t.CustomerId);$("#ddlBillStatus").val(t.BillStatus);e=t.BillDetails;t.BillDetails!=null&&t.BillDetails.length>0&&(f="",o=$("#template-table-bill-details").html(),$.each(e,function(n,t){var e=i(t.ProductId),s=r(t.ColorId),h=u(t.SizeId);f+=Mustache.render(o,{Id:t.Id,Products:e,Colors:s,Sizes:h,Quantity:t.Quantity})}),$("#tbl-bill-details").html(f));$("#modal-detail").modal("show");tedu.stopLoading()},error:function(){tedu.notify("Has an error in progress","error");tedu.stopLoading()}})});$("#btnSave").on("click",function(n){if($("#frmMaintainance").valid()){n.preventDefault();var i=$("#hidId").val(),u=$("#txtCustomerName").val(),e=$("#txtCustomerAddress").val(),o=$("#ddlCustomerId").val(),s=$("#txtCustomerMobile").val(),h=$("#txtCustomerMessage").val(),c=$("#ddlPaymentMethod").val(),l=$("#ddlBillStatus").val(),r=[];return $.each($("#tbl-bill-details tr"),function(n,t){r.push({Id:$(t).data("id"),ProductId:$(t).find("select.ddlProductId").first().val(),Quantity:$(t).find("input.txtQuantity").first().val(),ColorId:$(t).find("select.ddlColorId").first().val(),SizeId:$(t).find("select.ddlSizeId").first().val(),BillId:i})}),$.ajax({type:"POST",url:"/Admin/Bill/SaveEntity",data:{Id:i,BillStatus:l,CustomerAddress:e,CustomerId:o,CustomerMessage:h,CustomerMobile:s,CustomerName:u,PaymentMethod:c,Status:1,BillDetails:r},dataType:"json",beforeSend:function(){tedu.startLoading()},success:function(){tedu.notify("Save order successful","success");$("#modal-detail").modal("hide");f();tedu.stopLoading();t(!0)},error:function(){tedu.notify("Has an error in progress","error");tedu.stopLoading()}}),!1}});$("#btnAddDetail").on("click",function(){var n=$("#template-table-bill-details").html(),t=i(null),f=r(null),e=u(null),o=Mustache.render(n,{Id:0,Products:t,Colors:f,Sizes:e,Quantity:0,Total:0});$("#tbl-bill-details").append(o)});$("body").on("click",".btn-delete-detail",function(){$(this).parent().parent().remove()});$("#btnExport").on("click",function(){var n=$("#hidId").val();$.ajax({type:"POST",url:"/Admin/Bill/ExportExcel",data:{billId:n},beforeSend:function(){tedu.startLoading()},success:function(n){window.location.href=n;tedu.stopLoading()}})})}function o(){return $.ajax({type:"GET",url:"/admin/bill/GetBillStatus",dataType:"json",success:function(t){n.billStatuses=t;var i="";$.each(t,function(n,t){i+="<option value='"+t.Value+"'>"+t.Name+"<\/option>"});$("#ddlBillStatus").html(i)}})}function s(){return $.ajax({type:"GET",url:"/admin/bill/GetPaymentMethod",dataType:"json",success:function(t){n.paymentMethods=t;var i="";$.each(t,function(n,t){i+="<option value='"+t.Value+"'>"+t.Name+"<\/option>"});$("#ddlPaymentMethod").html(i)}})}function h(){return $.ajax({type:"GET",url:"/Admin/Product/GetAll",dataType:"json",success:function(t){n.products=t},error:function(){tedu.notify("Has an error in progress","error")}})}function c(){return $.ajax({type:"GET",url:"/Admin/Bill/GetColors",dataType:"json",success:function(t){n.colors=t},error:function(){tedu.notify("Has an error in progress","error")}})}function l(){return $.ajax({type:"GET",url:"/Admin/Bill/GetSizes",dataType:"json",success:function(t){n.sizes=t},error:function(){tedu.notify("Has an error in progress","error")}})}function i(t){var i="<select class='form-control ddlProductId'>";return $.each(n.products,function(n,r){i+=t===r.Id?'<option value="'+r.Id+'" selected="select">'+r.Name+"<\/option>":'<option value="'+r.Id+'">'+r.Name+"<\/option>"}),i+="<\/select>"}function r(t){var i="<select class='form-control ddlColorId'>";return $.each(n.colors,function(n,r){i+=t===r.Id?'<option value="'+r.Id+'" selected="select">'+r.Name+"<\/option>":'<option value="'+r.Id+'">'+r.Name+"<\/option>"}),i+="<\/select>"}function u(t){var i="<select class='form-control ddlSizeId'>";return $.each(n.sizes,function(n,r){i+=t===r.Id?'<option value="'+r.Id+'" selected="select">'+r.Name+"<\/option>":'<option value="'+r.Id+'">'+r.Name+"<\/option>"}),i+="<\/select>"}function f(){$("#hidId").val(0);$("#txtCustomerName").val("");$("#txtCustomerAddress").val("");$("#txtCustomerMobile").val("");$("#txtCustomerMessage").val("");$("#ddlPaymentMethod").val("");$("#ddlCustomerId").val("");$("#ddlBillStatus").val("");$("#tbl-bill-details").html("")}function t(n){$.ajax({type:"GET",url:"/admin/bill/GetAllPaging",data:{startDate:$("#txtFromDate").val(),endDate:$("#txtToDate").val(),keyword:$("#txtSearchKeyword").val(),page:tedu.configs.pageIndex,pageSize:tedu.configs.pageSize},dataType:"json",beforeSend:function(){tedu.startLoading()},success:function(i){var u=$("#table-template").html(),r="";i.RowCount>0?($.each(i.Results,function(n,t){r+=Mustache.render(u,{CustomerName:t.CustomerName,Id:t.Id,PaymentMethod:a(t.PaymentMethod),DateCreated:tedu.dateTimeFormatJson(t.DateCreated),BillStatus:v(t.BillStatus)})}),$("#lbl-total-records").text(i.RowCount),r!=undefined&&$("#tbl-content").html(r),y(i.RowCount,function(){t()},n)):($("#lbl-total-records").text("0"),$("#tbl-content").html(""));tedu.stopLoading()},error:function(n){console.log(n)}})}function a(t){var i=$.grep(n.paymentMethods,function(n){return n.Value==t});return i.length>0?i[0].Name:""}function v(t){var t=$.grep(n.billStatuses,function(n){return n.Value==t});return t.length>0?t[0].Name:""}function y(n,t,i){var r=Math.ceil(n/tedu.configs.pageSize);($("#paginationUL a").length===0||i===!0)&&($("#paginationUL").empty(),$("#paginationUL").removeData("twbs-pagination"),$("#paginationUL").unbind("page"));$("#paginationUL").twbsPagination({totalPages:r,visiblePages:7,first:"Đầu",prev:"Trước",next:"Tiếp",last:"Cuối",onPageClick:function(n,i){tedu.configs.pageIndex=i;setTimeout(t(),200)}})}var n={products:[],colors:[],sizes:[],paymentMethods:[],billStatuses:[]};this.initialize=function(){$.when(o(),s(),c(),l(),h()).done(function(){t()});e()}};